<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" th:replace="layout::head('WallRide')" />
		<title>WallRide</title>
	</head>
	<body>
		<header th:replace="layout::header"></header>
		<div>
			<div th:replace="layout::sidebar"></div>
			<div id="main">
				<ol class="breadcrumb">
					<li><a th:href="@{__${ADMIN_PATH}__/}" th:text="#{Dashboard}">Dashboard</a></li>
					<li class="active" th:text="#{Categories}">Categories</li>
				</ol>
				<div class="page-header clearfix">
					<h1 th:text="#{Categories}">Categories</h1>
				</div>
				<div class="alert alert-success" th:if="${savedCategory ne null}">
					<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					<span th:text="#{SavedCategory}">Category saved.</span>
				</div>
				<div class="alert alert-success" th:if="${deletedCategory ne null}">
					<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					<span th:text="#{DeletedCategory}">Category deleted.</span>
				</div>
				<div class="page-header clearfix">
					<div class="row">
						<div class="col-sm-2">
							<a th:href="@{__${ADMIN_PATH}__/categories/index?part=category-create-form}" data-toggle="modal" data-target="#category-create-modal" class="btn btn-primary"><span class="glyphicon glyphicon-plus"></span> <span th:text="#{AddNewCategory}">Add New</span></a>
						</div>
						<div class="col-sm-10">
							<div class="pull-right">
								<button id="update-category-sort" type="submit" class="btn btn-primary" data-loading-text="saving..." disabled="true" th:if="!${categoryTree.empty}" th:text="#{SaveOrder}">Save Order</button>
								<script th:inline="javascript">
									$(function() {
										$('#update-category-sort').click(function(e) {
											e.preventDefault();
											$(this).button('loading');
											var data = $('#category-tree').nestedSortable('toArray', {startDepthCount: 0});
											$.ajax({
												url: /*[[@{__${ADMIN_PATH}__/categories.json}]]*/ '#',
												type: 'put',
												dataType: 'json',
												data: JSON.stringify(data),
												contentType: 'application/json',
												success: function() {
													location = /*[[@{__${ADMIN_PATH}__/categories/index?updated}]]*/ '#';
												},
												error: function() {
												}
											});
										});
									});
								</script>
							</div>
						</div>
					</div>
				</div>
				<ul th:unless="${#lists.isEmpty(categoryTree.rootNodes)}" th:replace="category/index::category(${categoryTree.rootNodes})"></ul>
				<ul id="category-tree" class="sortable tree" th:fragment="category(nodes)">
					<li th:each="node : ${nodes}" th:id="${'category-tree_' + node.category.id}">
						<div class="category clearfix">
							<div class="wr-tree-options pull-left">
								<span class="wr-tree-option disclose"><span class="glyphicon glyphicon-chevron-right"></span></span>
								<span class="wr-tree-option title" th:text="${node.category.name}"></span>
								<span class="wr-tree-option" th:text="${'/' + node.category.code}">/code</span>
							</div>
							<div class="wr-tree-options pull-right">
								<span class="badge wr-tree-option" th:text="${articleCounts.get(node.category.id)}?:0">16</span>
								<button class="btn btn-link wr-tree-option" th:href="@{__${ADMIN_PATH}__/categories/index(part=category-edit-form,id=${node.category.id})}" data-toggle="modal" data-target="#category-edit-modal"><span class="glyphicon glyphicon-pencil"></span> <span th:text="#{Edit}">Edit</span></button>
								<button class="btn btn-link wr-tree-option" th:href="@{__${ADMIN_PATH}__/categories/index(part=category-create-form,parentId=${node.category.id})}" data-toggle="modal" data-target="#category-create-modal"><span class="glyphicon glyphicon-plus"></span> <span th:text="#{Add}">Add</span></button>
								<button class="btn btn-link wr-tree-option" th:href="@{__${ADMIN_PATH}__/categories/index(part=category-delete-form,id=${node.category.id})}" data-toggle="modal" data-target="#category-delete-modal"><span class="glyphicon glyphicon-remove"></span></button>
							</div>
						</div>
						<ul th:unless="${#lists.isEmpty(node.children)}" th:include="category/index::category(${node.children})"></ul>
					</li>
				</ul>
				<!-- #category-create-modal -->
				<div id="category-create-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
					<div id="category-create-dialog" class="modal-dialog">
						<div class="modal-content">
							<form th:fragment="category-create-form">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title" th:text="#{AddNewCategory}">Add New Category</h4>
								</div>
								<div class="modal-body">
									<div class="form-group">
										<select name="parentId" class="form-control">
											<option value="" th:text="#{SelectParentCategory}">Select Parent Category</option>
											<option th:each="category : ${categoryTree.categories}" th:value="${category.id}" th:text="${category.name}" th:selected="${category.id eq parentId}"></option>
										</select>
									</div>
									<div class="form-group">
										<input type="text" name="name" class="form-control" th:attr="placeholder=#{CategoryName}" />
									</div>
									<div class="form-group">
										<span th:text="${WEBSITE_LINK + '/category/'}">http://wallride.org/category/</span>
										<input type="text" name="code" class="form-control input-sm wr-code" th:attr="placeholder=#{URLPath}" />
									</div>
									<div class="form-group">
										<textarea name="description" class="form-control" th:attr="placeholder=#{Description}" style="min-height: 100px"></textarea>
									</div>
								</div>
								<div class="modal-footer">
									<button class="btn btn-default" data-dismiss="modal" th:text="#{Cancel}">Cancel</button>
									<button class="btn btn-primary" id="save-category" th:text="#{Save}">Save</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!--/#category-create-modal -->
				<script th:inline="javascript">
					$(function() {
						$('#main').on('click', '#save-category', function(e) {
							e.preventDefault();
							var self = this;
							$(self).button('loading');
							var form = $(this).closest('form');
							var data = {
								parentId: $(':input[name="parentId"]', form).val(),
								code: $(':input[name="code"]', form).val(),
								name: $(':input[name="name"]', form).val(),
								description: $(':input[name="description"]', form).val()
							};
							$.ajax({
								url: /*[[@{__${ADMIN_PATH}__/categories.json}]]*/ '#',
								type: 'post',
								data: data,
								success: function() {
									location = /*[[@{__${ADMIN_PATH}__/categories/index?created}]]*/ '#';
								},
								error: function(jqXHR) {
									$.each(jqXHR.responseJSON.fieldErrors, function(field, message) {
										var field = $(':input[name="' + field + '"]', form);
										$(field).closest('.form-group').addClass('has-error');
									});
									$(self).button('reset');
								}
							});
						});
						$('#main').on('hidden.bs.modal', '#category-create-modal', function() {
							$(this).removeData('bs.modal');
						});
					});
				</script>
				<!-- #category-edit-modal -->
				<div id="category-edit-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
					<div id="category-edit-dialog" class="modal-dialog">
						<div class="modal-content">
							<form th:fragment="category-edit-form" th:if="${category}">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title" th:text="#{EditCategory}">Edit Category</h4>
								</div>
								<div class="modal-body">
									<div class="form-group">
										<select name="parentId" class="form-control">
											<option value="" th:text="#{SelectParentCategory}">Select Parent Category</option>
											<option th:each="parent : ${categoryTree.categories}" th:if="${parent ne category}" th:value="${parent.id}" th:text="${parent.name}" th:selected="${parent eq category.parent}"></option>
										</select>
									</div>
									<div class="form-group">
										<input type="text" name="name" th:value="${category.name}" class="form-control" th:attr="placeholder=#{CategoryName}" placeholder="Category Name" />
									</div>
									<div class="form-group">
										<span th:text="${WEBSITE_LINK + '/category/'}">http://wallride.org/category/</span>
										<input type="text" name="code" th:value="${category.code}" class="form-control input-sm wr-code" th:attr="placeholder=#{URLPath}" placeholder="URLパス" />
									</div>
									<div class="form-group">
										<textarea name="description" class="form-control" th:attr="placeholder=#{Description}" placeholder="Description" style="min-height: 100px" th:text="${category.description}"></textarea>
									</div>
								</div>
								<div class="modal-footer">
									<button class="btn btn-default" data-dismiss="modal" th:text="#{Cancel}">Cancel</button>
									<button id="update-category" class="btn btn-primary" th:text="#{Save}" th:attr="data-id=${category.id}">Save</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!--/#category-edit-modal -->
				<script th:inline="javascript">
					$(function() {
						$('#main').on('click', '#update-category', function(e) {
							e.preventDefault();
							var self = $(this);
							self.button('loading');
							var form = self.closest('form');
							var data = {
								parentId: $(':input[name="parentId"]', form).val(),
								code: $(':input[name="code"]', form).val(),
								name: $(':input[name="name"]', form).val(),
								description: $(':input[name="description"]', form).val()
							};
							/*[+
							 var url = [[@{__${ADMIN_PATH}__/categories/}]] + self.data('id') + '.json';
							 +]*/
							$.ajax({
								url: url,
								type: 'post',
								data: data,
								success: function() {
									location = /*[[@{__${ADMIN_PATH}__/categories/index?updated}]]*/ '#';
								},
								error: function(jqXHR) {
									$.each(jqXHR.responseJSON.fieldErrors, function(field, message) {
										var field = $(':input[name="' + field + '"]', form);
										$(field).closest('.form-group').addClass('has-error');
									});
									$(self).button('reset');
								}
							});
						});
						$('#main').on('hidden.bs.modal', '#category-edit-modal', function() {
							$(this).removeData('bs.modal');
						});
					});
				</script>
				<!-- #category-delete-modal -->
				<div id="category-delete-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
					<div id="category-delete-dialog" class="modal-dialog">
						<div class="modal-content">
							<form th:fragment="category-delete-form">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title">Delete Category</h4>
								</div>
								<div class="modal-body">
									<p>Are you sure you want to delete?</p>
								</div>
								<div class="modal-footer">
									<button class="btn btn-default">Cancel</button>
									<button id="delete-category" class="btn btn-primary" th:attr="data-id=${targetId}">Delete</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!--/#category-delete-modal -->
				<script th:inline="javascript">
					$(function() {
						$('#category-tree').nestedSortable({
							forcePlaceholderSize: true,
							handle: 'div',
							helper:	'clone',
							items: 'li',
							opacity: .6,
							placeholder: 'placeholder',
							revert: 250,
							tabSize: 25,
							tolerance: 'pointer',
							toleranceElement: '> div',
							listType: 'ul',
							isTree: true,
							expandOnHover: 700
//							startCollapsed: true
						});
						$('#main').on('sortupdate', '#category-tree', function() {
							$('#update-category-sort').prop('disabled', false);
							$('button', $(this)).prop('disabled', true);
						});
						$('.disclose').on('click', function() {
							$(this).closest('li').toggleClass('mjs-nestedSortable-collapsed').toggleClass('mjs-nestedSortable-expanded');
						})
						$('#main').on('click', '#delete-category', function(e) {
							e.preventDefault();
							var self = $(this);
							self.button('loading');
							/*[+
							 var url = [[@{__${ADMIN_PATH}__/categories/}]] + self.data('id') + '.json';
							 +]*/
							$.ajax({
								url: url,
								type: 'delete',
								success: function() {
									$('#category-tree_' + self.data('id')).fadeOut(300, function() {
										location = /*[[@{__${ADMIN_PATH}__/categories/index?deleted}]]*/ '#';
									});
								},
								error: function() {
								}
							});
						});
					});
				</script>
			</div>
		</div>
		<footer>
		</footer>
	</body>
</html>